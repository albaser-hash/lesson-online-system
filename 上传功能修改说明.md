# 上传功能修改说明

## 修改概述

本次修改将系统的上传功能从预签名直传模式改为后端转发模式，以简化前端逻辑并提高系统可控性。

## 主要修改内容

### 1. 后端配置优化

**application.yml 配置更新**：
- 文件上传大小限制：从100MB提升到2GB
- 请求超时时间：增加到5分钟
- 临时文件存储：配置为 `/tmp/upload`
- 数据库连接池优化

### 2. 接口修改

**图片上传接口**：
- 原：`POST /admin/common/upload-image` (返回预签名URL)
- 新：`POST /admin/common/upload-image` (直接接收文件)

**视频上传接口**：
- 原：`POST /admin/common/upload-video` (返回预签名URL)
- 新：`POST /admin/common/upload-video` (直接接收文件)

**文档上传接口**：
- 保持不变：`POST /admin/common/upload-doc` (已经是转发模式)

### 3. 存储服务更新

**StorageService 接口**：
- 新增：`uploadFile(MultipartFile file, String objectName)`
- 保留：预签名下载URL相关方法

**实现类更新**：
- `MinioStorageService`：新增文件上传方法
- `OssStorageService`：新增文件上传方法

### 4. 前端修改

**upload.js**：
- 视频上传：改为直接上传到后端
- 保留：上传进度回调功能

**createCourse.js**：
- 图片上传：改为直接上传到后端
- 简化：移除预签名URL获取逻辑

### 5. 异常处理增强

**GlobalExceptionHandler**：
- 新增：`MaxUploadSizeExceededException` 处理
- 新增：`MultipartException` 处理
- 优化：文件上传错误提示

## 性能优化

### 1. 服务器配置
- 文件上传大小：2GB
- 请求超时：5分钟
- 临时文件阈值：10MB
- 连接池优化：支持大文件上传

### 2. 监控和日志
- 上传耗时统计
- 文件大小记录
- 错误日志完善

### 3. 临时文件管理
- 配置临时目录：`/tmp/upload`
- 提供清理脚本：`cleanup-temp.sh`
- 建议：每小时执行一次清理

## 部署注意事项

### 1. 服务器要求
- 确保 `/tmp/upload` 目录存在且有写权限
- 检查磁盘空间是否充足（建议预留10GB以上）
- 确认网络带宽支持大文件上传

### 2. 定时任务
```bash
# 添加到 crontab，每小时清理临时文件
0 * * * * /path/to/cleanup-temp.sh
```

### 3. 监控建议
- 监控临时目录大小
- 监控上传成功率
- 监控服务器内存使用

## 回滚方案

如需回滚到预签名模式：
1. 恢复 `CommonController` 中的预签名URL生成逻辑
2. 恢复前端的上传逻辑
3. 移除新增的 `uploadFile` 方法
4. 调整配置文件中的上传限制

## 测试建议

### 1. 功能测试
- 测试图片上传（<2MB）
- 测试视频上传（>100MB）
- 测试文档上传（各种格式）
- 测试上传进度显示

### 2. 性能测试
- 测试大文件上传（1GB+）
- 测试并发上传
- 测试网络异常情况
- 测试服务器重启后恢复

### 3. 异常测试
- 测试文件大小超限
- 测试文件类型错误
- 测试网络中断
- 测试磁盘空间不足

## 总结

本次修改简化了前端上传逻辑，提高了系统的可控性和稳定性。通过后端转发模式，可以更好地控制文件上传过程，提供更详细的错误信息和上传进度。

修改后的系统支持最大2GB文件上传，具备完善的异常处理和监控机制，适合企业级应用场景。 